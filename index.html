<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clan War Stats</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 1100px; margin: 28px auto; padding: 0 16px; color: #e8ebf0; background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.04), transparent 35%), radial-gradient(circle at 80% 0%, rgba(0, 212, 255, 0.08), transparent 25%), #0d1117; }
    h1 { margin: 0 0 10px; }
    .top { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    .muted { opacity: 0.75; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: linear-gradient(135deg, rgba(0,0,0,0.35), rgba(255,255,255,0.05)); color: inherit; cursor: pointer; box-shadow: 0 8px 18px rgba(0,0,0,0.25); }
    button:hover { border-color: rgba(255,255,255,0.3); background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(0,0,0,0.4)); }
    .ctaLink { margin-left: auto; display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 12px; text-decoration: none; font-weight: 700; color: #e8ebf0; background: linear-gradient(135deg, rgba(86, 38, 153, 0.35), rgba(141, 66, 245, 0.18)); border: 1px solid rgba(255,255,255,0.18); box-shadow: 0 10px 28px rgba(0,0,0,0.28); transition: transform 120ms ease, border-color 120ms ease, box-shadow 120ms ease; }
    .ctaLink:hover { border-color: rgba(255,255,255,0.34); transform: translateY(-1px); box-shadow: 0 12px 30px rgba(0,0,0,0.35); }
    .error { margin: 12px 0 18px; padding: 12px 14px; border-radius: 12px; background: rgba(255,0,0,0.12); border: 1px solid rgba(255,0,0,0.25); display:none; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; align-items: start; }
    .fullRow { grid-column: 1 / -1; }
    .card { border-radius: 16px; padding: 14px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 20px 60px rgba(0,0,0,0.28); }
    .cardHead { display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; }
    .title { font-size: 18px; font-weight: 700; letter-spacing: 0.2px; }
    pre { margin: 0; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); min-height: 260px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; cursor: pointer; }
    .toast { font-size: 13px; opacity: 0.8; height: 18px; margin-top: 8px; }
    .overviewTable { width: 100%; border-collapse: collapse; margin-top: 6px; }
    .overviewTable thead th { text-align: left; padding: 10px 12px; background: linear-gradient(135deg, rgba(0, 255, 170, 0.18), rgba(0, 112, 243, 0.12)); border-bottom: 1px solid rgba(255,255,255,0.12); font-weight: 700; font-size: 14px; letter-spacing: 0.1px; }
    .overviewTable tbody td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; }
    .overviewTable tbody tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    .overviewTable .clanName { font-weight: 700; font-size: 15px; }
    .overviewTable .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,0.08); font-size: 12px; margin-right: 6px; }
    .overviewTable .sortButton { background: none; border: none; color: inherit; font: inherit; padding: 0; cursor: pointer; }
    .overviewTable .sortButton:hover { text-decoration: underline; }
    .subtle { color: rgba(232,235,240,0.75); font-size: 13px; }
    .empty { padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.12); text-align: center; }
    .playersTable { width: 100%; border-collapse: collapse; margin-top: 6px; }
    .playersTable thead th { text-align: left; padding: 10px 12px; background: linear-gradient(135deg, rgba(255, 140, 0, 0.16), rgba(255, 255, 255, 0.05)); border-bottom: 1px solid rgba(255,255,255,0.12); font-weight: 700; font-size: 14px; letter-spacing: 0.1px; }
    .playersTable tbody td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; }
    .playersTable tbody tr:nth-child(odd) { background: rgba(255,255,255,0.02); }
    .playersTable .role { font-weight: 700; letter-spacing: 0.2px; }
    .playersTable .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; background: rgba(0, 170, 255, 0.15); font-size: 12px; margin-left: 6px; }
    @media (max-width: 950px) { .grid { grid-template-columns: 1fr; } pre { min-height: 180px; } }
    @media (max-width: 640px) {
      body { padding: 0 12px; }
      .top { flex-direction: column; align-items: stretch; gap: 10px; }
      .top button, .ctaLink { width: 100%; justify-content: center; text-align: center; }
      h1 { font-size: 26px; }
    }
  </style>
</head>
<body>
  <h1>Clan War Stats</h1>
  <div class="top">
    <div class="muted">Last updated: <span id="updated">-</span></div>
    <button id="refresh">Refresh</button>
    <div class="muted" id="status"></div>
    <a class="ctaLink" href="/join.html">Recent joins <span aria-hidden="true">â†’</span></a>
  </div>

  <div class="error" id="errorBox"></div>

  <div class="grid">
    <div class="card fullRow">
      <div class="cardHead">
        <div class="title">Race Overview</div>
      </div>
      <div id="overview" class="empty">(loading...)</div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Clan Stats</div>
        <button data-copy="clan">Copy</button>
      </div>
      <pre id="clan" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="clanToast"></div>
      <div class="muted" id="clanLen"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Spelers met nog losse aanvallen</div>
        <button data-copy="risk">Copy</button>
      </div>
      <pre id="risk" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="riskToast"></div>
      <div class="muted" id="riskLen"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Short story</div>
        <button data-copy="story">Copy</button>
      </div>
      <pre id="story" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="storyToast"></div>
      <div class="muted" id="storyLen"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Battles left (today)</div>
        <button data-copy="battles">Copy</button>
      </div>
      <pre id="battles" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="battlesToast"></div>
      <div class="muted" id="battlesLen"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Insights</div>
        <button data-copy="insights">Copy</button>
      </div>
      <pre id="insights" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="insightsToast"></div>
      <div class="muted" id="insightsLen"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Spelers 3000+ ðŸŒŸ</div>
        <button data-copy="highFame">Copy</button>
      </div>
      <pre id="highFame" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="highFameToast"></div>
      <div class="muted" id="highFameLen"></div>
    </div>

    <div class="card fullRow">
      <div class="cardHead">
        <div class="title">Players</div>
      </div>
      <div id="players" class="empty">(loading...)</div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);

  function updateLength(id, text, limit) {
    const target = el(id + "Len");
    if (!target) return;
    const len = (text || "").length;
    if (limit) {
      target.textContent = len ? `Length: ${len} / ${limit}` : "";
    } else {
      target.textContent = len ? `Length: ${len}` : "";
    }
  }

  let overviewData = { headCells: [], rows: [] };

  function buildOverviewTable(headCells, rows) {
    const container = el("overview");
    container.innerHTML = "";
    container.className = "tableWrap";

    const table = document.createElement("table");
    table.className = "overviewTable";

    const avgIdx = headCells.findIndex((cell) => cell.toLowerCase().includes("avg"));

    const thead = document.createElement("thead");
    const headTr = document.createElement("tr");
    headCells.forEach((cell, idx) => {
      const th = document.createElement("th");
      if (idx === avgIdx) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sortButton";
        btn.textContent = cell || (idx === 0 ? "Clan" : "");
        btn.addEventListener("click", () => sortOverviewByAvg());
        th.appendChild(btn);
      } else {
        th.textContent = cell || (idx === 0 ? "Clan" : "");
      }
      headTr.appendChild(th);
    });
    thead.appendChild(headTr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    rows.forEach((parts) => {
      const tr = document.createElement("tr");

      parts.forEach((p, idx) => {
        const td = document.createElement("td");
        if (idx === 0) {
          td.className = "clanName";
          td.textContent = p;
        } else if (idx === 1) {
          td.innerHTML = `<span class="pill">${p || "-"}</span>`;
        } else {
          td.textContent = p || "-";
        }
        tr.appendChild(td);
      });

      while (tr.children.length < headCells.length) {
        const td = document.createElement("td");
        td.textContent = "-";
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
  }

  function sortOverviewByAvg() {
    const avgIdx = overviewData.headCells.findIndex((cell) => cell.toLowerCase().includes("avg"));
    if (avgIdx === -1) return;

    const sortedRows = [...overviewData.rows].sort((a, b) => {
      const aVal = parseFloat(a[avgIdx]);
      const bVal = parseFloat(b[avgIdx]);
      if (Number.isNaN(aVal) && Number.isNaN(bVal)) return 0;
      if (Number.isNaN(aVal)) return 1;
      if (Number.isNaN(bVal)) return -1;
      return bVal - aVal;
    });

    buildOverviewTable(overviewData.headCells, sortedRows);
  }

  function renderOverviewTable(text) {
    const container = el("overview");
    container.innerHTML = "";

    if (!text || !text.trim()) {
      container.className = "empty";
      container.textContent = "(geen data)";
      return;
    }

    const lines = text.split("\n").map(l => l.trimEnd()).filter(Boolean);
    const dataLines = lines.filter(l => l.includes("|") && !/^[-|â€”\s]+$/.test(l));

    if (!dataLines.length) {
      container.className = "empty";
      container.textContent = text;
      return;
    }

    const [header, ...rows] = dataLines;
    const headCells = header.split("|").map(c => c.trim());
    const parsedRows = rows.map(line => line.split("|").map(p => p.trim()));
    overviewData = { headCells, rows: parsedRows };

    buildOverviewTable(headCells, parsedRows);
  }

  function renderPlayersTable(text) {
    const container = el("players");
    container.innerHTML = "";

    if (!text || !text.trim()) {
      container.className = "empty";
      container.textContent = "(geen data)";
      return;
    }

    const lines = text.split("\n").map(l => l.trimEnd()).filter(Boolean);
    const dataLines = lines.filter(l => l.includes("|") && !/^[-|â€”\s]+$/.test(l));

    if (!dataLines.length) {
      container.className = "empty";
      container.textContent = text;
      return;
    }

    container.className = "tableWrap";

    const table = document.createElement("table");
    table.className = "playersTable";

    const [header, ...rows] = dataLines;
    const headCells = header.split("|").map(c => c.trim());
    const thead = document.createElement("thead");
    const headTr = document.createElement("tr");
    headCells.forEach(cell => {
      const th = document.createElement("th");
      th.textContent = cell;
      headTr.appendChild(th);
    });
    thead.appendChild(headTr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    rows.forEach(line => {
      const parts = line.split("|").map(p => p.trim());
      const tr = document.createElement("tr");

      parts.forEach((p, idx) => {
        const td = document.createElement("td");
        if (idx === 0) {
          td.className = "role";
          td.textContent = p;
        } else if (idx === 1) {
          const [name, badge] = p.split(/\s+-\s+/);
          td.innerHTML = badge ? `${name} <span class="badge">${badge}</span>` : p;
        } else {
          td.textContent = p || "-";
        }
        tr.appendChild(td);
      });

      while (tr.children.length < headCells.length) {
        const td = document.createElement("td");
        td.textContent = "-";
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
  }

  async function copyText(targetId) {
    const map = {
      insights: "insights",
      clan: "clan",
      battles: "battles",
      risk: "risk",
      story: "story",
      highFame: "highFame",
    };
    const preId = map[targetId];
    const text = el(preId).textContent || "";
    await navigator.clipboard.writeText(text);

    const toastId = targetId + "Toast";
    el(toastId).textContent = "Copied!";
    setTimeout(() => { el(toastId).textContent = ""; }, 900);
  }

  async function fetchData() {
    el("errorBox").style.display = "none";
    el("status").textContent = "Loading...";

    const url = "/api/cwstats?t=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });

    if (!res.ok) {
      el("status").textContent = "";
      el("errorBox").style.display = "block";
      el("errorBox").textContent = "API error (" + res.status + ")";
      throw new Error("API error " + res.status);
    }

    const data = await res.json();
    if (!data.ok) {
      el("status").textContent = "";
      el("errorBox").style.display = "block";
      el("errorBox").textContent = "API error: " + (data.error || "unknown");
      throw new Error(data.error || "unknown");
    }

    renderOverviewTable(data.race_overview_text || "");
    el("insights").textContent = data.insights_text || "(geen data)";
    el("clan").textContent = data.clan_stats_text || "(geen data)";
    renderPlayersTable(data.players_text || "");
    el("battles").textContent = data.battles_left_text || "(geen data)";
    el("risk").textContent = data.risk_left_text || "(geen data)";
    el("highFame").textContent = data.high_fame_text || "(geen data)";
    el("story").textContent = data.short_story_text || "(geen data)";
    updateLength("insights", data.insights_text);
    updateLength("clan", data.clan_stats_text);
    updateLength("battles", data.battles_left_text);
    updateLength("risk", data.risk_left_text);
    updateLength("highFame", data.high_fame_text);
    updateLength("story", data.short_story_text, data.short_story_limit);

    el("updated").textContent = new Date().toLocaleString();
    el("status").textContent = "";
  }

  // Buttons
  el("refresh").addEventListener("click", () => fetchData());

  document.querySelectorAll("button[data-copy]").forEach(btn => {
    btn.addEventListener("click", () => copyText(btn.dataset.copy));
  });

  ["insights","clan","battles","risk","story","highFame"].forEach(id => {
    el(id).addEventListener("click", () => {
      copyText(id);
    });
  });

  // Run on load too
  fetchData().catch(() => {});
</script>
</body>
</html>
