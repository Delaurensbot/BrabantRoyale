<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clan War Stats</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 1100px; margin: 28px auto; padding: 0 16px; }
    h1 { margin: 0 0 10px; }
    .top { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
    .muted { opacity: 0.75; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.25); color: inherit; cursor: pointer; }
    .error { margin: 12px 0 18px; padding: 12px 14px; border-radius: 12px; background: rgba(255,0,0,0.12); border: 1px solid rgba(255,0,0,0.25); display:none; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
    .card { border-radius: 16px; padding: 14px; background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.10); }
    .cardHead { display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; }
    .title { font-size: 18px; font-weight: 700; }
    pre { margin: 0; padding: 12px; border-radius: 12px; background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.08); min-height: 260px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; cursor: pointer; }
    .toast { font-size: 13px; opacity: 0.8; height: 18px; margin-top: 8px; }
    @media (max-width: 950px) { .grid { grid-template-columns: 1fr; } pre { min-height: 180px; } }
  </style>
</head>
<body>
  <h1>Clan War Stats</h1>
  <div class="top">
    <div class="muted">Last updated: <span id="updated">-</span></div>
    <button id="refresh">Refresh</button>
    <div class="muted" id="status"></div>
  </div>

  <div class="error" id="errorBox"></div>

  <div class="grid">
    <div class="card">
      <div class="cardHead">
        <div class="title">Race Overview</div>
        <button data-copy="overview">Copy</button>
      </div>
      <pre id="overview" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="overviewToast"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Insights</div>
        <button data-copy="insights">Copy</button>
      </div>
      <pre id="insights" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="insightsToast"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Clan Stats</div>
        <button data-copy="clan">Copy</button>
      </div>
      <pre id="clan" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="clanToast"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Players</div>
        <button data-copy="players">Copy</button>
      </div>
      <pre id="players" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="playersToast"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Battles left (today)</div>
        <button data-copy="battles">Copy</button>
      </div>
      <pre id="battles" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="battlesToast"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Risk left attacks</div>
        <button data-copy="risk">Copy</button>
      </div>
      <pre id="risk" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="riskToast"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Short story</div>
        <button data-copy="story">Copy</button>
      </div>
      <pre id="story" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="storyToast"></div>
      <div class="muted" id="storyLen"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Copy All</div>
        <button data-copy="all">Copy</button>
      </div>
      <pre id="copyAll" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="copyAllToast"></div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);

  async function copyText(targetId) {
    const map = {
      overview: "overview",
      insights: "insights",
      clan: "clan",
      players: "players",
      battles: "battles",
      risk: "risk",
      story: "story",
      all: "copyAll",
    };
    const preId = map[targetId];
    const text = el(preId).textContent || "";
    await navigator.clipboard.writeText(text);

    const toastId = targetId + "Toast";
    el(toastId).textContent = "Copied!";
    setTimeout(() => { el(toastId).textContent = ""; }, 900);
  }

  async function fetchData() {
    el("errorBox").style.display = "none";
    el("status").textContent = "Loading...";

    const url = "/api/cwstats?t=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });

    if (!res.ok) {
      el("status").textContent = "";
      el("errorBox").style.display = "block";
      el("errorBox").textContent = "API error (" + res.status + ")";
      throw new Error("API error " + res.status);
    }

    const data = await res.json();
    if (!data.ok) {
      el("status").textContent = "";
      el("errorBox").style.display = "block";
      el("errorBox").textContent = "API error: " + (data.error || "unknown");
      throw new Error(data.error || "unknown");
    }

    el("overview").textContent = data.race_overview_text || "(geen data)";
    el("insights").textContent = data.insights_text || "(geen data)";
    el("clan").textContent = data.clan_stats_text || "(geen data)";
    el("players").textContent = data.players_text || "(geen data)";
    el("battles").textContent = data.battles_left_text || "(geen data)";
    el("risk").textContent = data.risk_left_text || "(geen data)";
    el("story").textContent = data.short_story_text || "(geen data)";
    el("copyAll").textContent = data.copy_all_text || "(geen data)";
    const storyLen = (data.short_story_text || "").length;
    if (data.short_story_limit) {
      el("storyLen").textContent = `Length: ${storyLen} / ${data.short_story_limit}`;
    } else {
      el("storyLen").textContent = storyLen ? `Length: ${storyLen}` : "";
    }

    el("updated").textContent = new Date().toLocaleString();
    el("status").textContent = "";
  }

  // Buttons
  el("refresh").addEventListener("click", () => fetchData());

  document.querySelectorAll("button[data-copy]").forEach(btn => {
    btn.addEventListener("click", () => copyText(btn.dataset.copy));
  });

  ["overview","insights","clan","players","battles","risk","story","copyAll"].forEach(id => {
    el(id).addEventListener("click", () => {
      const map = {
        overview:"overview", insights:"insights", clan:"clan", players:"players", battles:"battles", risk:"risk", story:"story", copyAll:"all"
      };
      copyText(map[id]);
    });
  });

  // Run on load too
  fetchData().catch(() => {});
</script>
</body>
</html>
