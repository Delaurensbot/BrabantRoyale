<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clan War Stats</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 1100px; margin: 28px auto; padding: 0 16px; color: #e8ebf0; background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.04), transparent 35%), radial-gradient(circle at 80% 0%, rgba(0, 212, 255, 0.08), transparent 25%), #0d1117; }
    h1 { margin: 0 0 10px; }
    .top { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    .muted { opacity: 0.75; }
    .clanSwitch { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0 6px; }
    .clanButton { padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.03); cursor: pointer; color: inherit; }
    .clanButton--active { border-color: rgba(0, 212, 255, 0.6); box-shadow: 0 8px 18px rgba(0,0,0,0.25); }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: linear-gradient(135deg, rgba(0,0,0,0.35), rgba(255,255,255,0.05)); color: inherit; cursor: pointer; box-shadow: 0 8px 18px rgba(0,0,0,0.25); }
    button:hover { border-color: rgba(255,255,255,0.3); background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(0,0,0,0.4)); }
    .ctaLink { margin-left: auto; display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 12px; text-decoration: none; font-weight: 700; color: #e8ebf0; background: linear-gradient(135deg, rgba(86, 38, 153, 0.35), rgba(141, 66, 245, 0.18)); border: 1px solid rgba(255,255,255,0.18); box-shadow: 0 10px 28px rgba(0,0,0,0.28); transition: transform 120ms ease, border-color 120ms ease, box-shadow 120ms ease; }
    .ctaLink:hover { border-color: rgba(255,255,255,0.34); transform: translateY(-1px); box-shadow: 0 12px 30px rgba(0,0,0,0.35); }
    .error { margin: 12px 0 18px; padding: 12px 14px; border-radius: 12px; background: rgba(255,0,0,0.12); border: 1px solid rgba(255,0,0,0.25); display:none; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; align-items: start; }
    .fullRow { grid-column: 1 / -1; }
    .card { border-radius: 16px; padding: 14px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 20px 60px rgba(0,0,0,0.28); }
    .cardHead { display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; }
    .title { font-size: 18px; font-weight: 700; letter-spacing: 0.2px; }
    pre { margin: 0; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); min-height: 260px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; cursor: pointer; }
    .toast { font-size: 13px; opacity: 0.8; height: 18px; margin-top: 8px; }
    .overviewTable { width: 100%; border-collapse: collapse; margin-top: 6px; }
    .overviewTable thead th { text-align: left; padding: 10px 12px; background: linear-gradient(135deg, rgba(0, 255, 170, 0.18), rgba(0, 112, 243, 0.12)); border-bottom: 1px solid rgba(255,255,255,0.12); font-weight: 700; font-size: 14px; letter-spacing: 0.1px; }
    .overviewTable tbody td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; }
    .overviewTable tbody tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    .overviewTable .clanName { font-weight: 700; font-size: 15px; }
    .overviewTable .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,0.08); font-size: 12px; margin-right: 6px; }
    .overviewTable .sortButton { background: none; border: none; color: inherit; font: inherit; padding: 0; cursor: pointer; }
    .overviewTable .sortButton:hover { text-decoration: underline; }
    .subtle { color: rgba(232,235,240,0.75); font-size: 13px; }
    .empty { padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.12); text-align: center; }
    .playersTable { width: 100%; border-collapse: collapse; margin-top: 6px; }
    .playersTable thead th { text-align: left; padding: 10px 12px; background: linear-gradient(135deg, rgba(255, 140, 0, 0.16), rgba(255, 255, 255, 0.05)); border-bottom: 1px solid rgba(255,255,255,0.12); font-weight: 700; font-size: 14px; letter-spacing: 0.1px; }
    .playersTable tbody td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; }
    .playersTable tbody tr:nth-child(odd) { background: rgba(255,255,255,0.02); }
    .playersTable .role { font-weight: 700; letter-spacing: 0.2px; }
    .playersTable .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; background: rgba(0, 170, 255, 0.15); font-size: 12px; margin-left: 6px; }
    .simpleTable { width: 100%; border-collapse: collapse; margin-top: 6px; }
    .simpleTable thead th { text-align: left; padding: 10px 12px; background: linear-gradient(135deg, rgba(0, 255, 170, 0.18), rgba(0, 112, 243, 0.12)); border-bottom: 1px solid rgba(255,255,255,0.12); font-weight: 700; font-size: 14px; letter-spacing: 0.1px; }
    .simpleTable tbody td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; }
    .simpleTable tbody tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    .hiddenCopy { display: none; }
    @media (max-width: 950px) { .grid { grid-template-columns: 1fr; } pre { min-height: 180px; } }
    @media (max-width: 640px) {
      body { padding: 0 12px; }
      .top { flex-direction: column; align-items: stretch; gap: 10px; }
      .top button, .ctaLink { width: 100%; justify-content: center; text-align: center; }
      h1 { font-size: 26px; }
    }
  </style>
</head>
<body>
  <h1>Clan War Stats</h1>
  <div class="clanSwitch" id="clanSwitch"></div>
  <div class="muted" id="clanLabel"></div>
  <div class="top">
    <div class="muted">Last updated: <span id="updated">-</span></div>
    <button id="refresh">Refresh</button>
    <div class="muted" id="status"></div>
    <a class="ctaLink" id="analyticsLink" href="/analytics.html">Analytics <span aria-hidden="true">â†’</span></a>
    <a class="ctaLink" id="joinLink" href="/join.html">Recent joins <span aria-hidden="true">â†’</span></a>
  </div>

  <div class="error" id="errorBox"></div>

  <div class="grid">
    <div class="card fullRow">
      <div class="cardHead">
        <div class="title">Race Overview</div>
      </div>
      <div id="overview" class="empty">(loading...)</div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Clan avg/projection</div>
        <button data-copy="clanAvg">Copy</button>
      </div>
      <pre id="clanAvg" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="clanAvgToast"></div>
      <div class="muted" id="clanAvgLen"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Spelers met nog losse aanvallen</div>
        <button data-copy="risk">Copy</button>
      </div>
      <pre id="risk" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="riskToast"></div>
      <div class="muted" id="riskLen"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Short story</div>
        <button data-copy="story">Copy</button>
      </div>
      <pre id="story" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="storyToast"></div>
      <div class="muted" id="storyLen"></div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="title">Battles left (today)</div>
        <button data-copy="battles">Copy</button>
      </div>
      <pre id="battles" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="battlesToast"></div>
      <div class="muted" id="battlesLen"></div>
    </div>

    <div class="card" id="highFameCard" style="display: none;">
      <div class="cardHead">
        <div class="title">Spelers 3000+ ðŸŒŸ</div>
        <button data-copy="highFame">Copy</button>
      </div>
      <pre id="highFame" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="highFameToast"></div>
      <div class="muted" id="highFameLen"></div>
    </div>

    <div class="card" id="day1Card" style="display: none;">
      <div class="cardHead">
        <div class="title">Spelers 800+</div>
        <button data-copy="day1HighFame">Copy</button>
      </div>
      <div id="day1HighFameWrap" class="empty">Alleen zichtbaar op dag 1</div>
      <pre id="day1HighFame" class="hiddenCopy" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="day1HighFameToast"></div>
      <div class="muted" id="day1HighFameLen"></div>
    </div>

    <div class="card" id="day4Card">
      <div class="cardHead">
        <div class="title">Spelers die nog 3k kunnen halen!</div>
        <button data-copy="day4">Copy</button>
      </div>
      <pre id="day4" title="Klik om te kopieren">(loading...)</pre>
      <div class="toast" id="day4Toast"></div>
      <div class="muted" id="day4Len"></div>
    </div>

    <div class="card fullRow">
      <div class="cardHead">
        <div class="title">Players</div>
      </div>
      <div id="players" class="empty">(loading...)</div>
    </div>
  </div>

<script>
  const el = (id) => document.getElementById(id);
  const CLANS = {
    "9YP8UY": { name: "Brabant Royale" },
    "GPCLVLPP": { name: "Brabant Royale 2" },
  };
  const DEFAULT_CLAN = "9YP8UY";

  function updateLength(id, text, limit) {
    const target = el(id + "Len");
    if (!target) return;
    const len = (text || "").length;
    if (limit) {
      target.textContent = len ? `Length: ${len} / ${limit}` : "";
    } else {
      target.textContent = len ? `Length: ${len}` : "";
    }
  }

  function normalizeClanTag(tag) {
    return (tag || "").replace(/[^A-Za-z0-9]/g, "").toUpperCase();
  }

  function clanName(tag) {
    return (CLANS[tag] && CLANS[tag].name) || CLANS[DEFAULT_CLAN].name;
  }

  function updateClanNavLinks() {
    const query = `?clan=${encodeURIComponent(currentClanTag)}`;
    const analyticsLink = el("analyticsLink");
    const joinLink = el("joinLink");
    if (analyticsLink) analyticsLink.href = `/analytics.html${query}`;
    if (joinLink) joinLink.href = `/join.html${query}`;
  }

  function updateClanLabel() {
    const label = el("clanLabel");
    if (label) {
      label.textContent = `Data voor ${clanName(currentClanTag)} (${currentClanTag})`;
    }
  }

  function setClan(tag, skipFetch = false) {
    const normalized = normalizeClanTag(tag);
    currentClanTag = CLANS[normalized] ? normalized : DEFAULT_CLAN;

    document.querySelectorAll(".clanButton").forEach((btn) => {
      if (btn.dataset.clan === currentClanTag) {
        btn.classList.add("clanButton--active");
      } else {
        btn.classList.remove("clanButton--active");
      }
    });

    updateClanLabel();
    updateClanNavLinks();
    if (!skipFetch) {
      fetchData().catch(() => {});
    }
  }

  function renderClanButtons() {
    const switchEl = el("clanSwitch");
    if (!switchEl) return;
    switchEl.innerHTML = "";

    Object.entries(CLANS).forEach(([tag, info]) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "clanButton";
      btn.dataset.clan = tag;
      btn.textContent = `${info.name} (${tag})`;
      btn.addEventListener("click", () => setClan(tag));
      switchEl.appendChild(btn);
    });
  }

  let overviewData = { headCells: [], rows: [] };
  let currentClanTag = DEFAULT_CLAN;

  function buildOverviewTable(headCells, rows) {
    const container = el("overview");
    container.innerHTML = "";
    container.className = "tableWrap";

    const table = document.createElement("table");
    table.className = "overviewTable";

    const avgIdx = headCells.findIndex((cell) => cell.toLowerCase().includes("avg"));

    const thead = document.createElement("thead");
    const headTr = document.createElement("tr");
    headCells.forEach((cell, idx) => {
      const th = document.createElement("th");
      if (idx === avgIdx) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "sortButton";
        btn.textContent = cell || (idx === 0 ? "Clan" : "");
        btn.addEventListener("click", () => sortOverviewByAvg());
        th.appendChild(btn);
      } else {
        th.textContent = cell || (idx === 0 ? "Clan" : "");
      }
      headTr.appendChild(th);
    });
    thead.appendChild(headTr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    rows.forEach((parts) => {
      const tr = document.createElement("tr");

      parts.forEach((p, idx) => {
        const td = document.createElement("td");
        if (idx === 0) {
          td.className = "clanName";
          td.textContent = p;
        } else if (idx === 1) {
          td.innerHTML = `<span class="pill">${p || "-"}</span>`;
        } else {
          td.textContent = p || "-";
        }
        tr.appendChild(td);
      });

      while (tr.children.length < headCells.length) {
        const td = document.createElement("td");
        td.textContent = "-";
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
  }

  function sortOverviewByAvg() {
    const avgIdx = overviewData.headCells.findIndex((cell) => cell.toLowerCase().includes("avg"));
    if (avgIdx === -1) return;

    const sortedRows = [...overviewData.rows].sort((a, b) => {
      const aVal = parseFloat(a[avgIdx]);
      const bVal = parseFloat(b[avgIdx]);
      if (Number.isNaN(aVal) && Number.isNaN(bVal)) return 0;
      if (Number.isNaN(aVal)) return 1;
      if (Number.isNaN(bVal)) return -1;
      return bVal - aVal;
    });

    buildOverviewTable(overviewData.headCells, sortedRows);
  }

  function renderOverviewTable(text) {
    const container = el("overview");
    container.innerHTML = "";

    if (!text || !text.trim()) {
      container.className = "empty";
      container.textContent = "(geen data)";
      return;
    }

    const lines = text.split("\n").map(l => l.trimEnd()).filter(Boolean);
    const dataLines = lines.filter(l => l.includes("|") && !/^[-|â€”\s]+$/.test(l));

    if (!dataLines.length) {
      container.className = "empty";
      container.textContent = text;
      return;
    }

    const [header, ...rows] = dataLines;
    const headCells = header.split("|").map(c => c.trim());
    const parsedRows = rows.map(line => line.split("|").map(p => p.trim()));
    overviewData = { headCells, rows: parsedRows };

    buildOverviewTable(headCells, parsedRows);
  }

  function renderPlayersTable(text) {
    const container = el("players");
    container.innerHTML = "";

    if (!text || !text.trim()) {
      container.className = "empty";
      container.textContent = "(geen data)";
      return;
    }

    const lines = text.split("\n").map(l => l.trimEnd()).filter(Boolean);
    const dataLines = lines.filter(l => l.includes("|") && !/^[-|â€”\s]+$/.test(l));

    if (!dataLines.length) {
      container.className = "empty";
      container.textContent = text;
      return;
    }

    container.className = "tableWrap";

    const table = document.createElement("table");
    table.className = "playersTable";

    const [header, ...rows] = dataLines;
    const headCells = header.split("|").map(c => c.trim());
    const thead = document.createElement("thead");
    const headTr = document.createElement("tr");
    headCells.forEach(cell => {
      const th = document.createElement("th");
      th.textContent = cell;
      headTr.appendChild(th);
    });
    thead.appendChild(headTr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    rows.forEach(line => {
      const parts = line.split("|").map(p => p.trim());
      const tr = document.createElement("tr");

      parts.forEach((p, idx) => {
        const td = document.createElement("td");
        if (idx === 0) {
          td.className = "role";
          td.textContent = p;
        } else if (idx === 1) {
          const [name, badge] = p.split(/\s+-\s+/);
          td.innerHTML = badge ? `${name} <span class="badge">${badge}</span>` : p;
        } else {
          td.textContent = p || "-";
        }
        tr.appendChild(td);
      });

      while (tr.children.length < headCells.length) {
        const td = document.createElement("td");
        td.textContent = "-";
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
  }

  function renderDay1HighFameTable(players, text) {
    const card = el("day1Card");
    const container = el("day1HighFameWrap");
    const hiddenPre = el("day1HighFame");

    if (!card || !container || !hiddenPre) return;

    const hasPlayers = Array.isArray(players) && players.length > 0;

    if (!hasPlayers || !text) {
      card.style.display = "none";
      container.innerHTML = "";
      hiddenPre.textContent = "";
      return;
    }

    card.style.display = "";
    hiddenPre.textContent = text;

    container.className = "tableWrap";
    container.innerHTML = "";

    const table = document.createElement("table");
    table.className = "simpleTable";

    const thead = document.createElement("thead");
    const headTr = document.createElement("tr");
    ["Speler", "Score"].forEach((label) => {
      const th = document.createElement("th");
      th.textContent = label;
      headTr.appendChild(th);
    });
    thead.appendChild(headTr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    players.forEach((player) => {
      const tr = document.createElement("tr");

      const nameTd = document.createElement("td");
      nameTd.textContent = player.name || "-";
      tr.appendChild(nameTd);

      const fameTd = document.createElement("td");
      fameTd.textContent = player.fame != null ? player.fame : "-";
      tr.appendChild(fameTd);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);
  }

  function formatClanAvgProjection(text) {
    if (!text || !text.trim()) return "(geen data)";

    const lines = text.split("\n").map((line) => line.trim()).filter(Boolean);
    const dataLines = lines.filter((line) => line.includes("|"));

    if (!dataLines.length) return text.trim();

    const rows = dataLines
      .map((line) => line.split("|").map((part) => part.trim()))
      .filter((parts) => parts.length >= 3 && parts[0].toLowerCase() !== "clan name");

    if (!rows.length) return text.trim();

    const sortedRows = [...rows].sort((a, b) => {
      const projectedA = parseFloat(a[2]);
      const projectedB = parseFloat(b[2]);

      const aIsNaN = Number.isNaN(projectedA);
      const bIsNaN = Number.isNaN(projectedB);

      if (aIsNaN && bIsNaN) return 0;
      if (aIsNaN) return 1;
      if (bIsNaN) return -1;

      if (projectedB !== projectedA) return projectedB - projectedA;

      const avgA = parseFloat(a[1]);
      const avgB = parseFloat(b[1]);
      if (Number.isNaN(avgA) || Number.isNaN(avgB)) return 0;
      return avgB - avgA;
    });

    const formattedRows = sortedRows
      .map(([name, avg, projected]) => `${name} ${avg || "-"} --> ${projected || "-"}`);

    return ["Clan avg --> Projected", ...formattedRows].join("\n\n");
  }

  async function copyText(targetId) {
    const map = {
      clanAvg: "clanAvg",
      battles: "battles",
      risk: "risk",
      story: "story",
      highFame: "highFame",
      day1HighFame: "day1HighFame",
      day4: "day4",
    };
    const preId = map[targetId];
    const text = el(preId).textContent || "";
    await navigator.clipboard.writeText(text);

    const toastId = targetId + "Toast";
    el(toastId).textContent = "Copied!";
    setTimeout(() => { el(toastId).textContent = ""; }, 900);
  }

  async function fetchData() {
    el("errorBox").style.display = "none";
    el("status").textContent = `Loading ${clanName(currentClanTag)}...`;

    const url = `/api/cwstats?clan=${encodeURIComponent(currentClanTag)}&t=${Date.now()}`;
    const res = await fetch(url, { cache: "no-store" });

    if (!res.ok) {
      el("status").textContent = "";
      el("errorBox").style.display = "block";
      el("errorBox").textContent = "API error (" + res.status + ")";
      throw new Error("API error " + res.status);
    }

    const data = await res.json();
    if (!data.ok) {
      el("status").textContent = "";
      el("errorBox").style.display = "block";
      el("errorBox").textContent = "API error: " + (data.error || "unknown");
      throw new Error(data.error || "unknown");
    }

    renderOverviewTable(data.race_overview_text || "");
    const formattedClanAvg = formatClanAvgProjection(data.clan_avg_projection_text || "");
    el("clanAvg").textContent = formattedClanAvg;
    renderPlayersTable(data.players_text || "");
    el("battles").textContent = data.battles_left_text || "(geen data)";
    el("risk").textContent = data.risk_left_text || "(geen data)";

    const highFameText = (data.high_fame_text || "").trim();
    const highFameCard = el("highFameCard");
    if (highFameCard) {
      if (highFameText) {
        highFameCard.style.display = "";
        el("highFame").textContent = highFameText;
      } else {
        highFameCard.style.display = "none";
        el("highFame").textContent = "";
      }
    }

    const day1Players = Array.isArray(data.day1_high_famers)
      ? data.day1_high_famers
      : [];
    const day1Text = (data.day1_high_fame_text || "").trim();
    renderDay1HighFameTable(day1Players, day1Text);

    const day4Text = (data.day4_last_chance_text || "").trim();
    const day4Card = el("day4Card");
    if (day4Card) {
      if (day4Text) {
        day4Card.style.display = "";
        el("day4").textContent = day4Text;
      } else {
        day4Card.style.display = "none";
        el("day4").textContent = "";
      }
    }

    el("story").textContent = data.short_story_text || "(geen data)";
    updateLength("clanAvg", formattedClanAvg);
    updateLength("battles", data.battles_left_text);
    updateLength("risk", data.risk_left_text);
    updateLength("highFame", highFameText);
    updateLength("day1HighFame", day1Text);
    updateLength("day4", day4Text);
    updateLength("story", data.short_story_text, data.short_story_limit);

    el("updated").textContent = new Date().toLocaleString();
    el("status").textContent = "";
  }

  // Buttons
  el("refresh").addEventListener("click", () => fetchData());

  document.querySelectorAll("button[data-copy]").forEach(btn => {
    btn.addEventListener("click", () => copyText(btn.dataset.copy));
  });

  ["clanAvg","battles","risk","story","highFame","day1HighFame","day4"].forEach(id => {
    el(id).addEventListener("click", () => {
      copyText(id);
    });
  });

  function init() {
    renderClanButtons();
    const params = new URLSearchParams(window.location.search);
    const desired = params.get("clan") || DEFAULT_CLAN;
    setClan(desired, true);
    fetchData().catch(() => {});
  }

  init();
</script>
</body>
</html>
