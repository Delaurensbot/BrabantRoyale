<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analytics Einde War</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial; max-width: 1100px; margin: 28px auto; padding: 0 16px; color: #e8ebf0; background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.04), transparent 35%), radial-gradient(circle at 80% 0%, rgba(0, 212, 255, 0.08), transparent 25%), #0d1117; }
    h1 { margin: 0 0 10px; }
    .top { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .muted { opacity: 0.8; }
    .clanSwitch { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
    .clanButton { padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.03); cursor: pointer; color: inherit; }
    .clanButton--active { border-color: rgba(0, 212, 255, 0.6); box-shadow: 0 8px 18px rgba(0,0,0,0.25); }
    a { color: #67c7ff; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: linear-gradient(135deg, rgba(0,0,0,0.35), rgba(255,255,255,0.05)); color: inherit; cursor: pointer; box-shadow: 0 8px 18px rgba(0,0,0,0.25); }
    button:hover { border-color: rgba(255,255,255,0.3); background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(0,0,0,0.4)); }
    .analyticsNav { display: flex; gap: 10px; flex-wrap: wrap; margin: 6px 0 16px; }
    .analyticsNav a { text-decoration: none; }
    .navBtn { padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.04); color: inherit; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
    .navBtn--active { border-color: rgba(0, 212, 255, 0.6); box-shadow: 0 8px 18px rgba(0,0,0,0.2); }
    .card { border-radius: 16px; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 20px 60px rgba(0,0,0,0.28); }
    .cardHead { display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px; gap: 12px; }
    .title { font-size: 18px; font-weight: 700; letter-spacing: 0.2px; }
    .section { margin-top: 12px; padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); }
    .section h3 { margin: 0 0 8px; font-size: 16px; }
    .statList { margin: 0; padding-left: 18px; line-height: 1.6; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    thead th { text-align: left; padding: 8px 10px; background: linear-gradient(135deg, rgba(0, 255, 170, 0.18), rgba(0, 112, 243, 0.12)); border-bottom: 1px solid rgba(255,255,255,0.12); font-weight: 700; font-size: 13px; }
    tbody td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 13px; }
    tbody tr:nth-child(even) { background: rgba(255,255,255,0.02); }
    .error { margin: 12px 0; padding: 12px 14px; border-radius: 12px; background: rgba(255,0,0,0.12); border: 1px solid rgba(255,0,0,0.25); display:none; }
    .toast { font-size: 13px; opacity: 0.8; height: 18px; margin-top: 6px; }
    .infoRow { margin-top: 10px; font-size: 13px; color: rgba(232,235,240,0.7); }
  </style>
</head>
<body>
  <div class="top">
    <h1 style="margin-right: 10px;">Einde war</h1>
    <a class="muted" id="dashboardLink" href="/index.html">‚Üê Terug naar dashboard</a>
    <button id="refresh">Refresh</button>
    <div class="muted" id="status"></div>
    <div class="muted" id="updated" style="margin-left:auto;"></div>
  </div>
  <div class="clanSwitch" id="clanSwitch"></div>
  <div class="analyticsNav">
    <a class="navBtn" id="overviewLink" href="/analytics.html">Overzicht</a>
    <a class="navBtn" id="recapLink" href="/analytics-recap.html">Recap</a>
    <span class="navBtn navBtn--active">Einde war</span>
  </div>
  <div class="muted" id="clanLabel"></div>
  <div class="error" id="errorBox"></div>

  <div class="card">
    <div class="cardHead">
      <div class="title">Einde war (laatste week)</div>
      <div>
        <button id="copyEndWar">Kopieer overzicht</button>
      </div>
    </div>
    <div class="toast" id="toastEndWar"></div>
    <div id="endWarContent">(laden...)</div>
    <div class="infoRow" id="endWarInfo"></div>
  </div>

<script>
  const el = (id) => document.getElementById(id);
  const CLANS = {
    "9YP8UY": { name: "Brabant Royale" },
    "GPCLVLPP": { name: "Brabant Royale 2" },
  };
  const DEFAULT_CLAN = "9YP8UY";
  let currentClanTag = DEFAULT_CLAN;
  let endWarText = '';

  function normalizeClanTag(tag) {
    return (tag || "").replace(/[^A-Za-z0-9]/g, "").toUpperCase();
  }

  function clanName(tag) {
    return (CLANS[tag] && CLANS[tag].name) || CLANS[DEFAULT_CLAN].name;
  }

  function updateClanLabel() {
    const label = el('clanLabel');
    if (label) {
      label.textContent = `Einde war voor ${clanName(currentClanTag)} (${currentClanTag})`;
    }
  }

  function updateNavLinks() {
    const query = `?clan=${encodeURIComponent(currentClanTag)}`;
    const dashboardLink = el('dashboardLink');
    const overviewLink = el('overviewLink');
    const recapLink = el('recapLink');
    if (dashboardLink) dashboardLink.href = `/index.html${query}`;
    if (overviewLink) overviewLink.href = `/analytics.html${query}`;
    if (recapLink) recapLink.href = `/analytics-recap.html${query}`;
  }

  function renderClanButtons() {
    const switchEl = el('clanSwitch');
    if (!switchEl) return;
    switchEl.innerHTML = '';

    Object.entries(CLANS).forEach(([tag, info]) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'clanButton';
      btn.dataset.clan = tag;
      btn.textContent = `${info.name} (${tag})`;
      btn.addEventListener('click', () => setClan(tag));
      switchEl.appendChild(btn);
    });
  }

  function setClan(tag, skipFetch = false) {
    const normalized = normalizeClanTag(tag);
    currentClanTag = CLANS[normalized] ? normalized : DEFAULT_CLAN;

    document.querySelectorAll('.clanButton').forEach((btn) => {
      if (btn.dataset.clan === currentClanTag) {
        btn.classList.add('clanButton--active');
      } else {
        btn.classList.remove('clanButton--active');
      }
    });

    updateClanLabel();
    updateNavLinks();
    if (!skipFetch) {
      fetchEndWar();
    }
  }

  function showError(msg) {
    const box = el('errorBox');
    box.textContent = msg;
    box.style.display = msg ? 'block' : 'none';
  }

  function copyText(text, toastEl) {
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
      if (toastEl) {
        toastEl.textContent = 'Copied!';
        setTimeout(() => (toastEl.textContent = ''), 1200);
      }
    });
  }

  function formatChange(value) {
    if (value === null || value === undefined) return 'Onbekend';
    return value > 0 ? `+${value}` : `${value}`;
  }

  function buildEndWarText(data) {
    const lines = [];
    lines.push('Titel: Einde war (laatste week)');
    lines.push('');
    lines.push('Resultaat');
    lines.push(`- Plaats: ${data.rank ?? 'Onbekend'}`);
    lines.push(`- Trophies: ${formatChange(data.trophy_change)} ‚Üí ${data.trophies_after ?? 'Onbekend'}`);
    lines.push(`- Boat points: ${data.boat_points ?? 'Onbekend'}`);
    lines.push('');
    lines.push('Beste speler');
    if (data.top_player && data.top_player.name) {
      lines.push(`- üèÖ ${data.top_player.name}: ${data.top_player.points} punten`);
    } else {
      lines.push('- üèÖ Onbekend');
    }
    lines.push('');
    lines.push('Aanvallen');
    lines.push(`- Spelers met 16/16: ${data.count16}`);
    lines.push(`- Totaal punten (16/16 spelers): ${data.sum_points_16}`);
    lines.push(`- Totaal gemiste aanvallen (alleen 1-15): ${data.missed_attacks_total}`);
    lines.push('');
    lines.push('Gemiste aanvallen (1-15)');
    if (data.missers && data.missers.length) {
      data.missers.forEach((row) => {
        lines.push(`- ${row.name}: ${row.attacks}/16 (${row.missed} gemist), ${row.points} punten`);
      });
    } else {
      lines.push('- Geen missers');
    }
    return lines.join('\n');
  }

  function renderEndWar(data) {
    const container = el('endWarContent');
    container.innerHTML = '';

    const resultSection = document.createElement('div');
    resultSection.className = 'section';
    resultSection.innerHTML = `
      <h3>Resultaat</h3>
      <ul class="statList">
        <li>Plaats: ${data.rank ?? 'Onbekend'}</li>
        <li>Trophies: ${formatChange(data.trophy_change)} ‚Üí ${data.trophies_after ?? 'Onbekend'}</li>
        <li>Boat points: ${data.boat_points ?? 'Onbekend'}</li>
      </ul>
    `;

    const topSection = document.createElement('div');
    topSection.className = 'section';
    const topName = data.top_player && data.top_player.name ? data.top_player.name : 'Onbekend';
    const topPoints = data.top_player && data.top_player.points ? data.top_player.points : 0;
    topSection.innerHTML = `
      <h3>Beste speler</h3>
      <ul class="statList">
        <li>üèÖ ${topName}: ${topPoints} punten</li>
      </ul>
    `;

    const attacksSection = document.createElement('div');
    attacksSection.className = 'section';
    attacksSection.innerHTML = `
      <h3>Aanvallen</h3>
      <ul class="statList">
        <li>Spelers met 16/16: ${data.count16}</li>
        <li>Totaal punten (16/16 spelers): ${data.sum_points_16}</li>
        <li>Totaal gemiste aanvallen (alleen 1-15): ${data.missed_attacks_total}</li>
      </ul>
    `;

    const missersSection = document.createElement('div');
    missersSection.className = 'section';
    const missers = data.missers || [];
    let missersHtml = '<h3>Gemiste aanvallen (1-15)</h3>';
    if (missers.length) {
      missersHtml += `
        <table>
          <thead>
            <tr>
              <th>Naam</th>
              <th>Aanvallen</th>
              <th>Gemist</th>
              <th>Punten</th>
            </tr>
          </thead>
          <tbody>
            ${missers
              .map(
                (row) => `
              <tr>
                <td>${row.name}</td>
                <td>${row.attacks}/16</td>
                <td>${row.missed}</td>
                <td>${row.points}</td>
              </tr>
            `
              )
              .join('')}
          </tbody>
        </table>
      `;
    } else {
      missersHtml += '<div class="muted">Geen missers</div>';
    }
    missersSection.innerHTML = missersHtml;

    container.appendChild(resultSection);
    container.appendChild(topSection);
    container.appendChild(attacksSection);
    container.appendChild(missersSection);

    endWarText = buildEndWarText(data);
    const info = [];
    if (data.member_filter_applied) info.push('Missers gefilterd op actuele clanleden.');
    if (data.source) info.push(`Bron: ${data.source}`);
    if (data.errors && data.errors.length) info.push(`Let op: ${data.errors.join(' | ')}`);
    el('endWarInfo').textContent = info.join(' ¬∑ ');
  }

  async function fetchEndWar() {
    showError('');
    el('status').textContent = `Laden voor ${clanName(currentClanTag)}...`;
    try {
      const res = await fetch(`/api/end_war?clan=${encodeURIComponent(currentClanTag)}`);
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'Onbekende fout');
      renderEndWar(json);
      el('status').textContent = '';
      el('updated').textContent = `Laatste refresh: ${new Date().toLocaleString()}`;
    } catch (e) {
      console.error(e);
      showError(e.message);
      el('status').textContent = '';
    }
  }

  el('refresh').addEventListener('click', fetchEndWar);
  el('copyEndWar').addEventListener('click', () => copyText(endWarText, el('toastEndWar')));

  function init() {
    renderClanButtons();
    const params = new URLSearchParams(window.location.search);
    const desired = params.get('clan') || DEFAULT_CLAN;
    setClan(desired, true);
    fetchEndWar();
  }

  init();
</script>
</body>
</html>
